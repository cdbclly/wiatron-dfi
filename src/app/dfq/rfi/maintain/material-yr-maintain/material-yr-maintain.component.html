<nz-breadcrumb>
  <nz-breadcrumb-item>DFQ System</nz-breadcrumb-item>
  <nz-breadcrumb-item>{{ 'dfq.rfi-new-model-yield-forecast' | translate }}</nz-breadcrumb-item>
  <nz-breadcrumb-item>{{ 'dfq.rfi-data-maintain' | translate }}</nz-breadcrumb-item>
  <nz-breadcrumb-item>{{ 'dfq.rfi-institutional-material-maintenance' | translate }}</nz-breadcrumb-item>
  <nz-breadcrumb-item>{{ 'dfq.rfi-material-factor-maintenance' | translate }}</nz-breadcrumb-item>
</nz-breadcrumb>
<div class="content">
  {{ 'dfq.rfi-material-factor-maintenance' | translate }}
</div>
<div class="dfc-query">
  <form nz-form [nzLayout]="'inline'" [formGroup]="validatorForm" (ngSubmit)="query()">
    <nz-form-item>
      <nz-form-label nzRequired>{{ 'dfq.dfq-product' | translate }}</nz-form-label>
      <nz-form-control nzErrorTip="Product cannot be empty">
        <nz-select nzShowSearch nzAllowClear formControlName="ProductId" [(ngModel)]="selectProduct"
          (ngModelChange)="getMaterial()">
          <ng-container *ngFor="let Product of Product">
            <nz-option [nzLabel]="Product.id" [nzValue]="Product.id"></nz-option>
          </ng-container>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label nzRequired>{{ 'dfq.dfq-plant' | translate }}</nz-form-label>
      <nz-form-control nzErrorTip="Site cannot be empty">
        <nz-select nzShowSearch nzAllowClear formControlName="SiteId" [(ngModel)]="selectSite"
          (ngModelChange)="getCustomers()">
          <nz-option *ngFor="let Site of Site" [nzValue]="Site" [nzLabel]="Site"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label>{{ 'dfq.dfq-material' | translate }}</nz-form-label>
      <nz-form-control>
        <nz-select nzShowSearch nzAllowClear nzLoading formControlName="MaterialId" [(ngModel)]="selectMaterial">
          <ng-container *ngFor="let item of Material">
            <nz-option [nzLabel]="item.name" [nzValue]="item.name"></nz-option>
          </ng-container>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label>{{ 'dfq.dfq-customer' | translate }}</nz-form-label>
      <nz-form-control>
        <nz-select nzShowSearch nzAllowClear formControlName="CustomerId" [(ngModel)]="selectCustomer"
          (ngModelChange)="getModels()">
          <nz-option *ngFor="let Customer of Customer" [nzLabel]="Customer" [nzValue]="Customer"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item class="selectmodel-cls">
      <nz-form-label nzRequired>{{ 'dfq.dfq-model' | translate }}</nz-form-label>
      <nz-form-control nzErrorTip="product cannot be empty">
        <nz-select nzMode="multiple" nzShowSearch nzAllowClear formControlName="ModelId" [(ngModel)]="selectModel">
          <nz-option *ngFor="let Model of Model; let i=index"  [nzLabel]="Model"  [nzValue]="Model"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-control class="query-cls">
        <button nz-button nzType="primary" [nzLoading]="isLoading"
          [disabled]="!validatorForm.valid">{{ 'dfq.dfq-query' | translate }}</button>
      </nz-form-control>
    </nz-form-item>
  </form>
</div>
<nz-divider></nz-divider>

<div class="dfc-btn" *ngIf="uploadShow">
  <label class="dfc-btn-add">
    <button nz-button [nzType]="'primary'" title="Add one" nzShape="circle" (click)="showModel()">
      <i class="anticon anticon-plus"></i>
    </button>
  </label>

  <div class="dfc-btn-right">
    <div class="dfc-btn-upload">
      <label class="text">{{ 'dfq.rfi-example' | translate }}</label>
      <label>
        <button nz-button nzType="primary" (click)="downDemo()">
          {{ 'dfq.rfi-download-template' | translate }}
        </button>
      </label>
      <nz-spin nzSimple [nzSpinning]="uploading">
        <label class="upload">
          <input id="upload" type="file" (change)="handleUploadFile($event.target)" />
          <div class="fakeInput">
            <span *ngIf="uploadFileName">{{ uploadFileName }}</span>
            <span *ngIf="!uploadFileName">Please select an Excel file</span>
          </div>
        </label>
        <label class="ant-btn ant-btn-primary ant-btn-icon-only ant-input-search-button upload" title="upload"
          (click)="upload()" *ngIf="upEnable">
          <i class="anticon anticon-upload"></i>
        </label>
      </nz-spin>
      <label class="dfc-btn-download">
        <!-- *ngIf="downShow && selectTable.length!==0" -->
        <button nz-button [nzType]="'primary'" title="download" [nzLoading]="downLoading" nzShape="circle"
          (click)="download()">
          <i class="anticon anticon-download"></i>
        </button>
      </label>
    </div>
  </div>
</div>

<div class="table-cls" *ngIf="tableShow">
  <nz-table #editRowTable id="ModelMaterialUpload" *ngIf="editCache !== undefined" nzBordered [nzData]="showData"
    [nzShowPagination]="isPagination" [nzShowSizeChanger]="true" [nzPageSize]="10">
    <thead>
      <tr>
        <th>{{ 'dfq.dfq-plant' | translate }}</th>
        <th>{{ 'dfq.dfq-customer' | translate }}</th>
        <th>{{ 'dfq.dfq-product' | translate }}</th>
        <th nzShowFilter [nzFilters]="listOfModel" (nzFilterChange)="filter($event,searchMaterial,searchPic)">
          {{ 'dfq.dfq-model' | translate }}</th>
        <th nzShowFilter nzCustomFilter [nzFilters]="listOfMaterial"
          (nzFilterChange)="filter(searchModel,$event,searchPic)">
          {{ 'dfq.dfq-material' | translate }}
          <label class="search-cls" (click)="seaechMaterial()" *ngIf="showSelectIcon"><i
              class="anticon anticon-search"></i></label>
          <div class="search-box" *ngIf="showSelect">
            <input type="text" nz-input placeholder="Search name" [(ngModel)]="searchMaterial" />
            <button nz-button nzSize="small" nzType="primary" (click)="search()" class="search-button">
              Search
            </button>
            <button nz-button nzSize="small" (click)="reset()">Reset</button>
          </div>
        </th>
        <th>{{ 'dfq.dfq-project' | translate }}</th>
        <th nzShowSort [(nzSort)]="sortValue" (nzSortChange)="sort(searchValue)">{{ 'dfq.dfq-yield' | translate }}</th>
        <th>Action</th>
        <th nzShowFilter [nzFilters]="listOfPic" (nzFilterChange)="filter(searchModel, searchMaterial,$event)">PIC</th>
        <th>{{ 'dfq.rfi-update-time' | translate }}</th>
        <!-- <th>簽核</th> -->
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let data of editRowTable.data">
        <td>
          <ng-container>
            {{data.site}}-{{data.plant}}
          </ng-container>
        </td>
        <td>
          <ng-container>
            {{ data.customer}}
          </ng-container>
        </td>
        <td>
          <ng-container>
            {{ data.product }}
          </ng-container>
        </td>
        <td>
          <ng-container>
            {{ data.modelId}}
          </ng-container>
        </td>
        <td>
          <ng-container>
            {{ data.material.name}}
          </ng-container>
        </td>
        <td (click)="showModal(data.id,data.modelId,data.site,data.plant,data.materialId)"><a
            class="link-cls">{{ 'dfq.rfi-details' | translate }}</a>
        </td>
        <td>
          <ng-container *ngIf="!editCache[data.id].edit; else yieldRateInputTpl">
            {{ data.yieldRate| percent }}
          </ng-container>
          <ng-template #yieldRateInputTpl>
            <nz-input-number [(ngModel)]="editCache[data.id].data.yieldRate" [nzMin]="0" [nzMax]="100" [nzStep]="0.01"
              [nzPlaceHolder]="'请输入0~100, Please enter 0~100'"></nz-input-number>
            <!-- <input type="text" nz-input [(ngModel)]="editCache[data.id].data.yieldRate" /> -->
          </ng-template>
        </td>
        <td>
          <nz-spin nzSimple *ngIf="!canEdit"></nz-spin>
          <ng-container *ngIf="!editCache[data.id].edit; else saveTpl">
            <a (click)="startEdit(data.id)" *ngIf="canEdit"><i nz-icon type="edit" theme="outline"></i></a>
          </ng-container>
          <ng-template #saveTpl>
            <a (click)="saveEdit(data.id)" *ngIf="canEdit"><i nz-icon type="save" theme="outline"></i></a>&nbsp;
            <a (click)="cancelEdit(data.id)" *ngIf="canEdit"><i nz-icon type="close" theme="outline"></i></a>
          </ng-template>
        </td>
        <td>
          <ng-container>
            {{data.pic | userEnname | async}}
          </ng-container>
        </td>
        <td>
          <ng-container>
            {{ data.updateOn ? (data.updateOn | datetime) : '' }}
          </ng-container>
        </td>
        <!-- <td>ok</td> -->
      </tr>
    </tbody>
  </nz-table>
</div>

<div>
  <nz-modal nzWidth="500px" class="model-cls" [(nzVisible)]="showAddModelMateril" nzOkText='OK' nzCancelText='Cancel' (nzOnOk)="addOne()"
    (nzOnCancel)="cancalAddModelMateril()" nzTitle="Add" [nzOkLoading]="isOkLoading">
    <label class="input-cls">
      <span class="model-span-cls">{{ 'dfq.dfq-plant' | translate }}:</span>
      <nz-select nzShowSearch [(ngModel)]="addSite" (ngModelChange)="getsitPlantModels()">
        <nz-option *ngFor="let Site of Site" [nzValue]="Site" [nzLabel]="Site"></nz-option>
      </nz-select>
    </label><br>
    <label class="input-cls">
      <span class="model-span-cls">{{ 'dfq.dfq-product' | translate }}: </span>
      <input class="model-input-cls" nz-input [(ngModel)]="selectProduct" [disabled]="true" nzSize="default" />
    </label> <br>
    <label class="input-cls">
      <span class="model-span-cls">{{ 'dfq.dfq-model' | translate }}:</span>
      <nz-select nzShowSearch [(ngModel)]="addModelId">
        <nz-option *ngFor="let Model of addselectModels" [nzLabel]="Model"  [nzValue]="Model"></nz-option>
      </nz-select>
    </label><br>
    <label class="input-cls">
      <span class="model-span-cls">{{ 'dfq.dfq-material' | translate }}: </span>
      <nz-select nzShowSearch [(ngModel)]="addMaterialId">
        <nz-option *ngFor="let item of Material" [nzLabel]="item.name" [nzValue]="item.id"></nz-option>
      </nz-select>
    </label><br>

  </nz-modal>
</div>
<nz-modal [(nzVisible)]="modelMessage" (nzOnOk)="handleOkMessage()" nzOkText='OK' nzCancelText='Cancel'  [nzCancelText]=null>
  <br>
  <p>{{ 'dfq.dfq-material' | translate }}{{ errUploadMaterial }} </p>
  <p>良率填寫"0~100的數字"不能為0或者空，請修改后重新上傳
    Fill in the "number from 0 to 100" for the yield rate and cannot be 0 or empty, please modify and upload again
  </p>
</nz-modal>
<app-factor-details-modal *ngIf="GETModelMaterialId" [newCombine]="newCombine" [isVisible]="isVisible"
  [selectMaterialId]="choiceMaterialId" [ModelMaterialUploadId]="ModelMaterialUploadId" [choiceSite]="choiceSite"
  [choicePlant]="choicePlant" [uploadModelId]="uploadModelId" [selectProduct]="selectProduct"
  (modalVisible)="modalVisible($event)" (savedModalVisible)="savedModalVisible($event)">
</app-factor-details-modal>

<nz-breadcrumb>
  <nz-breadcrumb-item>{{'dfi-monthly-meeting.meetingRecord' | translate  }}</nz-breadcrumb-item>
  <nz-breadcrumb-item>{{ 'dfi-monthly-meeting.monthly-meeting-report' | translate }}</nz-breadcrumb-item>
</nz-breadcrumb>
<div style="margin-top: 12px; text-align: center;">
  <h2 style="font-weight: bold;">{{ 'dfi-monthly-meeting.monthly-meeting-report' | translate }}</h2>
</div>
<div class="query-wrapper">
  <span class="label-span required">{{'dfi-monthly-meeting.month' | translate  }}</span>
  <nz-month-picker [nzFormat]="monthFormat" [(ngModel)]="selectedMonth"></nz-month-picker>
  <button nz-button nzType="primary" [disabled]="!selectedMonth" [nzLoading]="queryLoading"
    (click)="query(selectedMonth)">{{'dfq.dfq-query'|translate}}</button>
</div>
<nz-divider></nz-divider>
<nz-spin [nzSpinning]="saveLoading">
  <div>
    <nz-card class="attendence-card-wrapper" [nzBodyStyle]="cardBodyStyle" [nzTitle]="titleTemplate"
      [nzExtra]="extraTemplate">
      <ul [hidden]="isCollpase">
        <li *ngFor="let site of objectKeys(attendees)">
          <div class="attendence-card-label">{{site}}</div>
          <div class="attendence-list-wrapper">
            <div *ngFor="let item of attendees[site]" class="attendence-item"
              [@deleteAttendence]="attendees === {} ? 'noAnimate' : 'animate'">
              <div nz-checkbox [(ngModel)]="item.status" [nzDisabled]="queryMonth !== curMonth"
                (click)="checkOne(item, $event)" [ngStyle]="{'border': item.status ? '1.2px solid' : '1.2px dashed'}"
                class="item">
                {{item.employeeId | userEnname| async}}</div>
              <i nz-icon nz-popconfirm nzTitle="Are you sure you want to delete this item?" nzOkText='OK' nzCancelText='Cancel' (nzOnConfirm)="deleteOne(item, $event)" type="minus-circle"
                theme="outline" [hidden]="curMonth !== queryMonth"></i>
            </div>
          </div>
        </li>
      </ul>
    </nz-card>
    <ng-template #titleTemplate>
      <div [ngClass]="{'collapse-is': isCollpase, 'collapse-no': !isCollpase}" (click)="cardCollpase()">{{ 'dfi-monthly-meeting.attendance' | translate }}</div>
    </ng-template>
    <ng-template #extraTemplate>
      <div class="searchAttendence" [ngStyle]="{'visibility': curMonth !== queryMonth ? 'hidden' : 'visible'}">
        <app-search-user (selectedUserData)="addAttendees($event)"></app-search-user>
        <i class="search" nz-icon type="search" theme="outline"></i>
      </div>
    </ng-template>
  </div>
  <nz-divider></nz-divider>
  <div class="issue-track">
    <button [hidden]="curMonth !== queryMonth" nz-button [nzType]="'primary'" style="float: left;margin-right: 10px;"
      title="新增" nzShape="circle" (click)="showModal()">
      <i class="anticon anticon-plus"></i>
    </button>
    <button nz-button nzType="primary" style="float: left;margin-right: 10px;" [nzLoading]="saveLoading"
      [disabled]="queryMonth !== curMonth" (click)="save()">{{'dfq.dfq-save'|translate}}</button>
    <button nz-button nzType="primary" style="float: left;margin-right: 10px;" [nzLoading]="sendLoading"
      [disabled]="!isMeetingDate||(queryMonth !== curMonth)" nz-popconfirm nzTitle="Sure to send mail?"
      (nzOnConfirm)="sendMeetingMail()">
      {{ 'dfi-monthly-meeting.send-mail' | translate }}
    </button>
    <h2>{{ 'dfi-monthly-meeting.event-tracking' | translate }}</h2>
  </div>
  <div class="issue-table-wrapper">
    <nz-table #issueTable nzBordered [nzData]="trackingIssues" nzPageSize="5">
      <thead (nzSortChange)="sort($event)" nzSingleSort>
        <tr>
          <th>{{ 'dfi-monthly-meeting.serial-number' | translate }}</th>
          <th>{{ 'dfi-monthly-meeting.proposer' | translate }}</th>
          <th nzWidth="220px">{{ 'mrr.nudd-describe' | translate }}</th>
          <th>{{ 'dfi-monthly-meeting.principal' | translate }}</th>
          <th nzShowSort nzSortKey="dueDate">{{ 'dfi-monthly-meeting.deadline' | translate }}</th>
          <th>{{ 'dfi-monthly-meeting.closing-time' | translate }}</th>
          <th nzShowSort nzSortKey="status">{{'dfq.dfq-status'|translate}}</th>
          <th nzWidth="220px">{{ 'dfi-monthly-meeting.reply' | translate }}</th>
          <th>{{ 'dfi-monthly-meeting.operating' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of issueTable.data; let i=index">
          <td>{{i + 1}}</td>
          <td>{{data.initiator | userEnname | async}}</td>
          <td>{{data.description}}</td>
          <td>
            <div *ngFor="let pic of data.trackingIssuePics"> {{pic.employerId | userEnname | async}}</div>
          </td>
          <td>{{data.dueDate | date:"yyyy-MM-dd"}}</td>
          <td>{{data.closingTime | date:"yyyy-MM-dd"}}</td>
          <td>
            <div *ngIf="data.status === 'Close'else open" class="green-circle"></div>
            <ng-template #open>
              <div *ngIf="data.status === 'Open' else delay" class="green-circle"></div>
            </ng-template>
            <ng-template #delay>
              <div *ngIf="getExpirationDays(data.dueDate) > 0 else ongoing" class="red-circle"></div>
            </ng-template>
            <ng-template #ongoing>
              <div *ngIf="data.status === 'Ongoing'else open" class="orange-circle"></div>
            </ng-template>
            {{data.status == 'Ongoing' && getExpirationDays(data.dueDate) > 0 ? 'Delay' : data.status}}
          </td>
          <td>{{data.picReply}}</td>
          <td>
            <ng-container *ngIf="curMonth !== queryMonth || data.status ==='Close'; else elseTemplate">
              <span class="no-operate">{{ 'dfi-monthly-meeting.prohibited-operation' | translate }}</span>
            </ng-container>
            <ng-template #elseTemplate>
              <span><a (click)="showModal(data.id)"><i nz-icon type="edit" theme="outline"></i></a></span>|
              <span><a nz-popconfirm nzTitle="Are you sure you want to delete this item?" nzOkText='OK' nzCancelText='Cancel'  (nzOnConfirm)="deleteIssueRaw(data.id)">
                <i nz-icon type="delete" theme="outline"></i></a></span>
            </ng-template>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </div>
</nz-spin>

<nz-modal [nzBodyStyle]="modalBodyStyle" [(nzVisible)]="isVisible" [nzTitle]="modalTitle" (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()" nzOkText='OK' nzCancelText='Cancel' >
  <form nz-form *ngIf="editCache">
    <nz-form-item>
      <nz-form-label [nzSpan]="5"><span class="required">{{ 'dfi-monthly-meeting.proposer' | translate }}</span></nz-form-label>
      <nz-form-control [nzSpan]="18" [nzValidateStatus]="editCache.initiator ? '' : 'error'" nzHasFeedback>
        <app-search-user (selectedUserData)="chooseUser($event, editCache, 'initiator', 'email', 'ename')"
          [picId]="editCache.initiator"></app-search-user>
        <nz-form-explain [hidden]="editCache.initiator">Please enter the sponsor</nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item *ngFor="let pic of editCache.trackingIssuePics;let i = index" style="margin-bottom: 0;">
      <nz-form-label [nzSpan]="5">
        <ng-container *ngIf="i===0">
          <span class="required">{{ 'dfi-monthly-meeting.principal' | translate }}</span>
        </ng-container>
      </nz-form-label>
      <nz-form-control [nzSpan]="18" [nzOffset]="i==0?0:4"
        [nzValidateStatus]="i === 0 ? (pic.employerId ? '' : 'error') : ''" nzHasFeedback>
        <app-search-user
          (selectedUserData)="chooseUser($event, editCache.trackingIssuePics[i], 'employerId', 'email', 'ename')"
          [picId]="pic.employerId"></app-search-user>
        <i nz-icon type="minus-circle-o" class="dynamic-delete-button" [hidden]="i===0"
          (click)="removeField($event, i)"></i>
        <nz-form-explain [hidden]="i !== 0 || pic.employerId">Please enter the sponsor Please enter the person in charge</nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <!-- [hidden] 隱藏元素依然不在當前佈局中，???，改用 visibility -->
      <nz-form-label
        [ngStyle]="{'visibility': editCache.trackingIssuePics && editCache.trackingIssuePics.length > 0 ? 'hidden' : 'visible'}">
        {{ 'dfi-monthly-meeting.principal' | translate }}</nz-form-label>
      <nz-form-control>
        <button nz-button nzType="dashed" style="width:90%;" (click)="addField($event)"><i nz-icon type="plus"></i> Add
        </button>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label [nzSpan]="5">{{ 'dfi-monthly-meeting.deadline' | translate }}</nz-form-label>
      <nz-form-control [nzSpan]="18">
        <nz-date-picker nzFormat="yyyy-MM-dd" [(ngModel)]="editCache.dueDate" [ngModelOptions]="{standalone: true}">
        </nz-date-picker>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label>{{ 'dfq.dfq-status' | translate }}</nz-form-label>
      <nz-form-control>
        <nz-select style="width: 90%;" [(ngModel)]="editCache.status" nzAllowClear="false"
          [ngModelOptions]="{standalone: true}">
          <nz-option nzValue="Open" nzLabel="Open"></nz-option>
          <nz-option nzValue="Ongoing" nzLabel="Ongoing"></nz-option>
          <nz-option nzValue="Close" nzLabel="Close"></nz-option>
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label nzRequired="true" [nzSpan]="5">{{ 'mrr.nudd-describe' | translate }}</nz-form-label>
      <nz-form-control [nzSpan]="18" [nzValidateStatus]="editCache.description ? '' : 'error'" nzHasFeedback>
        <textarea style="width: 90%;" [(ngModel)]="editCache.description" nz-input rows="2" placeholder="Description"
          [ngModelOptions]="{standalone: true}"></textarea>
        <nz-form-explain [hidden]="editCache.description">{{ 'dfi-monthly-meeting.please-enter-description' | translate }}</nz-form-explain>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <nz-form-label>{{ 'dfi-monthly-meeting.reply' | translate }}</nz-form-label>
      <nz-form-control>
        <textarea style="width: 90%;" [(ngModel)]="editCache.picReply" nz-input rows="2" placeholder="PIC 回復"
          [ngModelOptions]="{standalone: true}"></textarea>
      </nz-form-control>
    </nz-form-item>
  </form>
</nz-modal>
